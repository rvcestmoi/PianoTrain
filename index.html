<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rognage de Partition</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.34/Tone.min.js"></script>
    <style>
        body {
            display: flex;
            flex-direction: column;
            align-items: center;
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
        }
        h1 {
            margin-top: 20px;
        }
        .controls {
            margin: 20px 0;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .control {
            margin: 10px;
        }
        .cropped-images-container {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        .cropped-images {
            display: flex;
            flex-wrap: wrap;
            gap: 0px;
            margin-top: 0px;
        }
        .cropped-image {
            overflow: hidden;
            width: 50px;
            height: 191px;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            flex-direction: column;
        }
        .cropped-image img {
            position: absolute;
        }
        .note-label {
            font-size: 14px;
            font-weight: bold;
            color: #333;
            margin-top: -150px;
            margin-right: 33px;
            position: relative;
            display: none; /* Masqué par défaut */
        }
    </style>
</head>
<body>
    <h1>Rognage de Partition</h1>
    
    <div class="controls">
        <div class="control">
            <label for="noteIntervalSlider">Temps entre les sons (ms): <span id="noteIntervalValue">600</span></label>
            <input type="range" id="noteIntervalSlider" min="100" max="1000" step="50" value="600">
        </div>
        <div class="control">
            <label for="soundDelaySlider">Délai avant le son (ms): <span id="soundDelayValue">3000</span></label>
            <input type="range" id="soundDelaySlider" min="0" max="5000" step="100" value="3000">
        </div>
        <div class="control">
            <label for="difficultySlider">Difficulté: <span id="difficultyValue">3</span></label>
            <input type="range" id="difficultySlider" min="1" max="5" step="1" value="3">
        </div>
        <div class="control">
            <label for="numNotesSlider">Nombre de notes: <span id="numNotesValue">5</span></label>
            <input type="range" id="numNotesSlider" min="3" max="10" step="1" value="5">
        </div>
        <div class="control">
            <label for="clefSelect">Clé:</label>
            <select id="clefSelect">
                <option value="sol">Clé de Sol</option>
                <option value="fa">Clé de Fa</option>
                <option value="sol_fa">Clé de Sol + Clé de Fa</option>
            </select>
        </div>
        <div class="control">
            <input type="checkbox" id="toggleLabels" checked>
            <label for="toggleLabels">Afficher les labels</label>
        </div>
        <button id="startStopButton">Start</button>
    </div>
    
    <div class="cropped-images-container">
        <div class="cropped-images" id="croppedImagesSol"></div>
        <div class="cropped-images" id="croppedImagesFa"></div>
    </div>

    <script>
        let noteInterval = 600;
        let soundDelay = 3000;
        let difficulty = 3;
        let clef = 'sol';
        let showLabels = true;
        let numNotes = 5;
        let intervalId = null;
        let isPlaying = false;

        const croppedImagesSolContainer = document.getElementById('croppedImagesSol');
        const croppedImagesFaContainer = document.getElementById('croppedImagesFa');
        const noteIntervalSlider = document.getElementById('noteIntervalSlider');
        const soundDelaySlider = document.getElementById('soundDelaySlider');
        const difficultySlider = document.getElementById('difficultySlider');
        const numNotesSlider = document.getElementById('numNotesSlider');
        const clefSelect = document.getElementById('clefSelect');
        const toggleLabels = document.getElementById('toggleLabels');
        const noteIntervalValue = document.getElementById('noteIntervalValue');
        const soundDelayValue = document.getElementById('soundDelayValue');
        const difficultyValue = document.getElementById('difficultyValue');
        const numNotesValue = document.getElementById('numNotesValue');
        const startStopButton = document.getElementById('startStopButton');

        const synthSol = new Tone.Synth().toDestination();
        const synthFa = new Tone.Synth().toDestination();

        const notesPositionsSol = [
            {"leftMin": 0, "leftMax": 43, "top": 0, "note": "A4"},
            {"leftMin": 43, "leftMax": 96, "top": 0, "note": "B4"},
            {"leftMin": 96, "leftMax": 149, "top": 0, "note": "C4"},
            {"leftMin": 149, "leftMax": 202, "top": 0, "note": "D4"},
            {"leftMin": 202, "leftMax": 255, "top": 0, "note": "E4"},
            {"leftMin": 255, "leftMax": 308, "top": 0, "note": "F4"},
            {"leftMin": 308, "leftMax": 361, "top": 0, "note": "G4"},
            {"leftMin": 361, "leftMax": 414, "top": 0, "note": "A5"},
            {"leftMin": 414, "leftMax": 467, "top": 0, "note": "B5"},
            {"leftMin": 467, "leftMax": 520, "top": 0, "note": "C5"},
            {"leftMin": 520, "leftMax": 573, "top": 0, "note": "D5"},
            {"leftMin": 573, "leftMax": 626, "top": 0, "note": "E5"},
            {"leftMin": 626, "leftMax": 679, "top": 0, "note": "F6"},
            {"leftMin": 679, "leftMax": 732, "top": 0, "note": "G6"},
            {"leftMin": 732, "leftMax": 785, "top": 0, "note": "A6"},
            {"leftMin": 785, "leftMax": 838, "top": 0, "note": "B6"},
            {"leftMin": 838, "leftMax": 869, "top": 0, "note": "C6"}
        ];

        const notesPositionsFa = [
            {"leftMin": 0, "leftMax": 43, "top": 0, "note": "C3"},
            {"leftMin": 43, "leftMax": 96, "top": 0, "note": "D3"},
            {"leftMin": 96, "leftMax": 149, "top": 0, "note": "E3"},
            {"leftMin": 149, "leftMax": 202, "top": 0, "note": "F3"},
            {"leftMin": 202, "leftMax": 255, "top": 0, "note": "G3"},
            {"leftMin": 255, "leftMax": 308, "top": 0, "note": "A3"},
            {"leftMin": 308, "leftMax": 361, "top": 0, "note": "B3"},
            {"leftMin": 361, "leftMax": 414, "top": 0, "note": "C4"},
            {"leftMin": 414, "leftMax": 467, "top": 0, "note": "D4"},
            {"leftMin": 467, "leftMax": 520, "top": 0, "note": "E4"},
            {"leftMin": 520, "leftMax": 573, "top": 0, "note": "F4"},
            {"leftMin": 573, "leftMax": 626, "top": 0, "note": "G4"},
            {"leftMin": 626, "leftMax": 679, "top": 0, "note": "A4"},
            {"leftMin": 679, "leftMax": 732, "top": 0, "note": "B4"},
            {"leftMin": 732, "leftMax": 785, "top": 0, "note": "C5"},
            {"leftMin": 785, "leftMax": 838, "top": 0, "note": "D5"},
            {"leftMin": 838, "leftMax": 869, "top": 0, "note": "E5"}
        ];

        function getIntervalRange(difficultyLevel) {
            return difficultyLevel === 1 ? 4 : difficultyLevel + 3;
        }

        function calculateImageChangeInterval() {
            return numNotes * (noteInterval + 1) + soundDelay;
        }

        async function playNotes(notesSol, notesFa) {
            const now = Tone.now();
            notesSol.forEach((note, i) => {
                synthSol.triggerAttackRelease(note, "8n", now + i * (noteInterval / 1000));
            });
            notesFa.forEach((note, i) => {
                synthFa.triggerAttackRelease(note, "8n", now + i * (noteInterval / 1000));
            });
            await new Promise(resolve => setTimeout(resolve, Math.max(notesSol.length, notesFa.length) * noteInterval));
        }

        function displayNotes(notes, container) {
            notes.forEach(position => {
                const div = document.createElement('div');
                div.className = 'cropped-image';

                const img = document.createElement('img');
                img.src = 'images/notes.png';
                img.style.left = `-${position.leftMin}px`;
                img.style.top = `-${position.top}px`;

                const noteLabel = document.createElement('div');
                noteLabel.className = 'note-label';
                noteLabel.textContent = position.note;

                div.appendChild(img);
                div.appendChild(noteLabel);
                container.appendChild(div);

                // Affiche les labels après le délai
                setTimeout(() => {
                    noteLabel.style.display = showLabels ? 'block' : 'none';
                }, soundDelay);
            });
        }

        async function updateNotes() {
            croppedImagesSolContainer.innerHTML = '';
            croppedImagesFaContainer.innerHTML = '';

            const range = getIntervalRange(difficulty);
            let selectedNotesSol = [];
            let selectedNotesFa = [];

            if (clef === 'sol' || clef === 'sol_fa') {
                const startPositionSol = Math.floor(Math.random() * (notesPositionsSol.length - range));
                const possibleNotesSol = notesPositionsSol.slice(startPositionSol, startPositionSol + range);
                selectedNotesSol.push(possibleNotesSol.reduce((min, note) => (note.leftMin < min.leftMin ? note : min)));
                for (let i = 1; i < numNotes; i++) {
                    selectedNotesSol.push(possibleNotesSol[Math.floor(Math.random() * possibleNotesSol.length)]);
                }
                displayNotes(selectedNotesSol, croppedImagesSolContainer);
            }

            if (clef === 'fa' || clef === 'sol_fa') {
                const startPositionFa = Math.floor(Math.random() * (notesPositionsFa.length - range));
                const possibleNotesFa = notesPositionsFa.slice(startPositionFa, startPositionFa + range);
                selectedNotesFa.push(possibleNotesFa.reduce((min, note) => (note.leftMin < min.leftMin ? note : min)));
                for (let i = 1; i < numNotes; i++) {
                    selectedNotesFa.push(possibleNotesFa[Math.floor(Math.random() * possibleNotesFa.length)]);
                }
                displayNotes(selectedNotesFa, croppedImagesFaContainer);
            }

            const notesToPlaySol = selectedNotesSol.map(n => n.note);
            const notesToPlayFa = selectedNotesFa.map(n => n.note);

            await new Promise(resolve => setTimeout(resolve, soundDelay));
            await playNotes(notesToPlaySol, notesToPlayFa);
        }

        toggleLabels.addEventListener('change', () => {
            showLabels = toggleLabels.checked;
        });

        startStopButton.addEventListener('click', async () => {
            if (isPlaying) {
                clearInterval(intervalId);
                intervalId = null;
                startStopButton.textContent = 'Start';
                isPlaying = false;
            } else {
                await Tone.start();
                updateNotes();
                const calculatedInterval = calculateImageChangeInterval();
                intervalId = setInterval(updateNotes, calculatedInterval);
                startStopButton.textContent = 'Stop';
                isPlaying = true;
            }
        });

        noteIntervalSlider.addEventListener('input', () => {
            noteInterval = parseInt(noteIntervalSlider.value);
            noteIntervalValue.textContent = noteInterval;
        });

        soundDelaySlider.addEventListener('input', () => {
            soundDelay = parseInt(soundDelaySlider.value);
            soundDelayValue.textContent = soundDelay;
        });

        difficultySlider.addEventListener('input', () => {
            difficulty = parseInt(difficultySlider.value);
            difficultyValue.textContent = difficulty;
        });

        numNotesSlider.addEventListener('input', () => {
            numNotes = parseInt(numNotesSlider.value);
            numNotesValue.textContent = numNotes;
        });

        clefSelect.addEventListener('change', () => {
            clef = clefSelect.value;
        });

        initializeSliders();
    </script>
</body>
</html>
