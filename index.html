<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rognage de Partition</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.34/Tone.min.js"></script>
    <style>
        body {
            display: flex;
            flex-direction: column;
            align-items: center;
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
        }
        h1 {
            margin-top: 20px;
        }
        .controls {
            margin: 20px 0;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .control {
            margin: 10px;
        }
        .cropped-images {
            display: flex;
            flex-wrap: wrap;
            gap: 0px;
            margin-top: 0px;
        }
        .cropped-image {
            overflow: hidden;
            width: 50px;
            height: 191px;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            flex-direction: column;
        }
        .cropped-image img {
            position: absolute;
        }
        .note-label {
            font-size: 14px;
            font-weight: bold;
            color: #333;
            margin-top: -150px;
            margin-right: 33px;
            position: relative;
        }
    </style>
</head>
<body>
    <h1>Rognage de Partition</h1>
    
    <div class="controls">
        <div class="control">
            <label for="noteIntervalSlider">Temps entre les sons (ms): <span id="noteIntervalValue">600</span></label>
            <input type="range" id="noteIntervalSlider" min="100" max="1000" step="50" value="600">
        </div>
        <div class="control">
            <label for="imageChangeIntervalSlider">Temps entre les changements d'image (ms): <span id="imageChangeIntervalValue">6000</span></label>
            <input type="range" id="imageChangeIntervalSlider" min="1000" max="10000" step="500" value="6000">
        </div>
        <div class="control">
            <label for="soundDelaySlider">Délai avant le son (ms): <span id="soundDelayValue">3000</span></label>
            <input type="range" id="soundDelaySlider" min="0" max="5000" step="100" value="3000">
        </div>
        <div class="control">
            <label for="difficultySlider">Difficulté: <span id="difficultyValue">3</span></label>
            <input type="range" id="difficultySlider" min="1" max="5" step="1" value="3">
        </div>
        <div class="control">
            <label for="numNotesSlider">Nombre de notes: <span id="numNotesValue">5</span></label>
            <input type="range" id="numNotesSlider" min="3" max="10" step="1" value="5">
        </div>
        <div class="control">
            <label for="clefSelect">Clé:</label>
            <select id="clefSelect">
                <option value="sol">Clé de Sol</option>
                <option value="fa">Clé de Fa</option>
            </select>
        </div>
        <div class="control">
            <input type="checkbox" id="toggleLabels" checked>
            <label for="toggleLabels">Afficher les labels</label>
        </div>
        <button id="startStopButton">Start</button>
    </div>
    
    <div class="cropped-images"></div>

    <script>
        let noteInterval = 600;
        let imageChangeInterval = 6000;
        let soundDelay = 3000;
        let difficulty = 3;
        let clef = 'sol';
        let showLabels = true;
        let numNotes = 5;
        let intervalId = null;
        let isPlaying = false;

        const croppedImagesContainer = document.querySelector('.cropped-images');
        const noteIntervalSlider = document.getElementById('noteIntervalSlider');
        const imageChangeIntervalSlider = document.getElementById('imageChangeIntervalSlider');
        const soundDelaySlider = document.getElementById('soundDelaySlider');
        const difficultySlider = document.getElementById('difficultySlider');
        const numNotesSlider = document.getElementById('numNotesSlider');
        const clefSelect = document.getElementById('clefSelect');
        const toggleLabels = document.getElementById('toggleLabels');
        const noteIntervalValue = document.getElementById('noteIntervalValue');
        const imageChangeIntervalValue = document.getElementById('imageChangeIntervalValue');
        const soundDelayValue = document.getElementById('soundDelayValue');
        const difficultyValue = document.getElementById('difficultyValue');
        const numNotesValue = document.getElementById('numNotesValue');
        const startStopButton = document.getElementById('startStopButton');

        const synth = new Tone.Synth().toDestination();

        const notesPositionsSol = [
            {"leftMin": 0, "leftMax": 43, "top": 0, "note": "A4"},
            {"leftMin": 43, "leftMax": 96, "top": 0, "note": "B4"},
            {"leftMin": 96, "leftMax": 149, "top": 0, "note": "C4"},
            {"leftMin": 149, "leftMax": 202, "top": 0, "note": "D4"},
            {"leftMin": 202, "leftMax": 255, "top": 0, "note": "E4"},
            {"leftMin": 255, "leftMax": 308, "top": 0, "note": "F4"},
            {"leftMin": 308, "leftMax": 361, "top": 0, "note": "G4"},
            {"leftMin": 361, "leftMax": 414, "top": 0, "note": "A5"},
            {"leftMin": 414, "leftMax": 467, "top": 0, "note": "B5"},
            {"leftMin": 467, "leftMax": 520, "top": 0, "note": "C5"},
            {"leftMin": 520, "leftMax": 573, "top": 0, "note": "D5"},
            {"leftMin": 573, "leftMax": 626, "top": 0, "note": "E5"},
            {"leftMin": 626, "leftMax": 679, "top": 0, "note": "F6"},
            {"leftMin": 679, "leftMax": 732, "top": 0, "note": "G6"},
            {"leftMin": 732, "leftMax": 785, "top": 0, "note": "A6"},
            {"leftMin": 785, "leftMax": 838, "top": 0, "note": "B6"},
            {"leftMin": 838, "leftMax": 869, "top": 0, "note": "C6"}
        ];

        const notesPositionsFa = [
            {"leftMin": 0, "leftMax": 43, "top": 0, "note": "C3"},
            {"leftMin": 43, "leftMax": 96, "top": 0, "note": "D3"},
            {"leftMin": 96, "leftMax": 149, "top": 0, "note": "E3"},
            {"leftMin": 149, "leftMax": 202, "top": 0, "note": "F3"},
            {"leftMin": 202, "leftMax": 255, "top": 0, "note": "G3"},
            {"leftMin": 255, "leftMax": 308, "top": 0, "note": "A3"},
            {"leftMin": 308, "leftMax": 361, "top": 0, "note": "B3"},
            {"leftMin": 361, "leftMax": 414, "top": 0, "note": "C4"},
            {"leftMin": 414, "leftMax": 467, "top": 0, "note": "D4"},
            {"leftMin": 467, "leftMax": 520, "top": 0, "note": "E4"},
            {"leftMin": 520, "leftMax": 573, "top": 0, "note": "F4"},
            {"leftMin": 573, "leftMax": 626, "top": 0, "note": "G4"},
            {"leftMin": 626, "leftMax": 679, "top": 0, "note": "A4"},
            {"leftMin": 679, "leftMax": 732, "top": 0, "note": "B4"},
            {"leftMin": 732, "leftMax": 785, "top": 0, "note": "C5"},
            {"leftMin": 785, "leftMax": 838, "top": 0, "note": "D5"},
            {"leftMin": 838, "leftMax": 869, "top": 0, "note": "E5"}
        ];

        function getNotesPositions() {
            return clef === 'fa' ? notesPositionsFa : notesPositionsSol;
        }

        function initializeSliders() {
            noteIntervalSlider.value = noteInterval;
            imageChangeIntervalSlider.value = imageChangeInterval;
            soundDelaySlider.value = soundDelay;
            difficultySlider.value = difficulty;
            numNotesSlider.value = numNotes;
            clefSelect.value = clef;
            toggleLabels.checked = showLabels;

            noteIntervalValue.textContent = noteInterval;
            imageChangeIntervalValue.textContent = imageChangeInterval;
            soundDelayValue.textContent = soundDelay;
            difficultyValue.textContent = difficulty;
            numNotesValue.textContent = numNotes;
        }

        noteIntervalSlider.addEventListener('input', () => {
            noteInterval = parseInt(noteIntervalSlider.value);
            noteIntervalValue.textContent = noteInterval;
        });

        imageChangeIntervalSlider.addEventListener('input', () => {
            imageChangeInterval = parseInt(imageChangeIntervalSlider.value);
            imageChangeIntervalValue.textContent = imageChangeInterval;
        });

        soundDelaySlider.addEventListener('input', () => {
            soundDelay = parseInt(soundDelaySlider.value);
            soundDelayValue.textContent = soundDelay;
        });

        difficultySlider.addEventListener('input', () => {
            difficulty = parseInt(difficultySlider.value);
            difficultyValue.textContent = difficulty;
        });

        numNotesSlider.addEventListener('input', () => {
            numNotes = parseInt(numNotesSlider.value);
            numNotesValue.textContent = numNotes;
        });

        clefSelect.addEventListener('change', () => {
            clef = clefSelect.value;
        });

        toggleLabels.addEventListener('change', () => {
            showLabels = toggleLabels.checked;
        });

        startStopButton.addEventListener('click', async () => {
            if (isPlaying) {
                clearInterval(intervalId);
                intervalId = null;
                startStopButton.textContent = 'Start';
                isPlaying = false;
            } else {
                await Tone.start();
                updateNotes();
                intervalId = setInterval(updateNotes, imageChangeInterval);
                startStopButton.textContent = 'Stop';
                isPlaying = true;
            }
        });

        function getRandomInt(min, max) {
            return Math.floor(Math.random() * (max - min + 1)) + min;
        }

        function getIntervalRange(difficultyLevel) {
            return difficultyLevel === 1 ? 3 : difficultyLevel * 2 + 1;
        }

        async function playNotes(notes) {
            for (const note of notes) {
                synth.triggerAttackRelease(note, "8n");
                await new Promise(resolve => setTimeout(resolve, noteInterval));
            }
        }

        async function updateNotes() {
    croppedImagesContainer.innerHTML = '';
    const notesPositions = getNotesPositions();
    const range = getIntervalRange(difficulty); // Définit la plage en fonction de la difficulté
    const startPosition = getRandomInt(0, notesPositions.length - range);
    const possibleNotes = notesPositions.slice(startPosition, startPosition + range);

    // Sélectionne la note la plus basse pour la première position
    const lowestNote = possibleNotes.reduce((min, note) => (note.leftMin < min.leftMin ? note : min));
    let selectedNotes = [lowestNote];

    // Remplit le reste de `selectedNotes` avec des notes aléatoires de `possibleNotes`, répétitions autorisées
    for (let i = 1; i < numNotes; i++) {
        const randomIndex = getRandomInt(0, possibleNotes.length - 1);
        selectedNotes.push(possibleNotes[randomIndex]);
    }

    selectedNotes.forEach(position => {
        const div = document.createElement('div');
        div.className = 'cropped-image';

        const img = document.createElement('img');
        img.src = 'images/notes.png';
        img.style.left = `-${position.leftMin}px`;
        img.style.top = `-${position.top}px`;

        const noteLabel = document.createElement('div');
        noteLabel.className = 'note-label';
        noteLabel.textContent = position.note;

        noteLabel.style.display = showLabels ? 'block' : 'none';

        div.appendChild(img);
        div.appendChild(noteLabel);
        croppedImagesContainer.appendChild(div);
    });

    const notesToPlay = selectedNotes.map(noteObj => noteObj.note);
    await new Promise(resolve => setTimeout(resolve, soundDelay));
    await playNotes(notesToPlay);
}


        initializeSliders();
    </script>
</body>
</html>
