<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rognage de Partition</title>
    <style>
        body {
            display: flex;
            flex-direction: column;
            align-items: center;
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
        }
        h1 {
            margin-top: 20px;
        }
        .controls {
            margin: 20px 0;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .control {
            margin: 10px;
        }
        .cropped-images {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 20px;
        }
        .cropped-image {
            overflow: hidden;
            width: 50px;
            height: 150px;
            border: 1px solid #ccc;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            flex-direction: column;
        }
        .cropped-image img {
            position: absolute;
        }
        .note-label {
            font-size: 16px;
            font-weight: bold;
            color: #333;
            margin-top: 120px;
            position: relative;
        }
        .debug-info {
            font-size: 12px;
            color: #555;
            position: absolute;
            bottom: 5px;
            left: 5px;
            background: rgba(255, 255, 255, 0.8);
            padding: 2px;
        }
    </style>
</head>
<body>
    <h1>Rognage de Partition</h1>
    
    <div class="controls">
        <div class="control">
            <label for="noteIntervalSlider">Temps entre les sons (ms): <span id="noteIntervalValue">300</span></label>
            <input type="range" id="noteIntervalSlider" min="100" max="1000" step="50" value="300">
        </div>
        <div class="control">
            <label for="imageChangeIntervalSlider">Temps entre les changements d'image (ms): <span id="imageChangeIntervalValue">7000</span></label>
            <input type="range" id="imageChangeIntervalSlider" min="1000" max="10000" step="500" value="7000">
        </div>
        <div class="control">
            <label for="soundDelaySlider">Délai avant le son (ms): <span id="soundDelayValue">2000</span></label>
            <input type="range" id="soundDelaySlider" min="0" max="5000" step="100" value="2000">
        </div>
        <div class="control">
            <label for="difficultySlider">Difficulté: <span id="difficultyValue">1</span></label>
            <input type="range" id="difficultySlider" min="1" max="5" step="1" value="1">
        </div>
        <button id="startStopButton">Start</button>
    </div>
    
    <div class="cropped-images"></div>

    <script>
        let noteInterval = 300;
        let imageChangeInterval = 7000;
        let soundDelay = 2000;
        let difficulty = 1;
        let intervalId = null;
        let isPlaying = false;

        const croppedImagesContainer = document.querySelector('.cropped-images');
        const noteIntervalSlider = document.getElementById('noteIntervalSlider');
        const imageChangeIntervalSlider = document.getElementById('imageChangeIntervalSlider');
        const soundDelaySlider = document.getElementById('soundDelaySlider');
        const difficultySlider = document.getElementById('difficultySlider');
        const noteIntervalValue = document.getElementById('noteIntervalValue');
        const imageChangeIntervalValue = document.getElementById('imageChangeIntervalValue');
        const soundDelayValue = document.getElementById('soundDelayValue');
        const difficultyValue = document.getElementById('difficultyValue');
        const startStopButton = document.getElementById('startStopButton');

        noteIntervalSlider.addEventListener('input', () => {
            noteInterval = parseInt(noteIntervalSlider.value);
            noteIntervalValue.textContent = noteInterval;
        });

        imageChangeIntervalSlider.addEventListener('input', () => {
            imageChangeInterval = parseInt(imageChangeIntervalSlider.value);
            imageChangeIntervalValue.textContent = imageChangeInterval;
        });

        soundDelaySlider.addEventListener('input', () => {
            soundDelay = parseInt(soundDelaySlider.value);
            soundDelayValue.textContent = soundDelay;
        });

        difficultySlider.addEventListener('input', () => {
            difficulty = parseInt(difficultySlider.value);
            difficultyValue.textContent = difficulty;
        });

        startStopButton.addEventListener('click', () => {
            if (isPlaying) {
                clearInterval(intervalId);
                intervalId = null;
                startStopButton.textContent = 'Start';
                isPlaying = false;
            } else {
                updateNotes();
                intervalId = setInterval(updateNotes, imageChangeInterval);
                startStopButton.textContent = 'Stop';
                isPlaying = true;
            }
        });

        const notesPositions = [
            { leftMin: 0, leftMax: 50, top: 0, note: 'C5', position: 1 },
            { leftMin: 50, leftMax: 100, top: 0, note: 'D5', position: 2 },
            { leftMin: 100, leftMax: 150, top: 0, note: 'E5', position: 3 },
            { leftMin: 150, leftMax: 200, top: 0, note: 'F5', position: 4 },
            { leftMin: 200, leftMax: 250, top: 0, note: 'G5', position: 5 },
            { leftMin: 0, leftMax: 50, top: 50, note: 'A5', position: 6 },
            { leftMin: 50, leftMax: 100, top: 50, note: 'B5', position: 7 },
            { leftMin: 100, leftMax: 150, top: 50, note: 'C6', position: 8 },
            { leftMin: 150, leftMax: 200, top: 50, note: 'D6', position: 9 },
            { leftMin: 200, leftMax: 250, top: 50, note: 'E6', position: 10 },
            { leftMin: 250, leftMax: 300, top: 50, note: 'F6', position: 11 },
            { leftMin: 300, leftMax: 350, top: 50, note: 'G6', position: 12 },
            { leftMin: 350, leftMax: 400, top: 50, note: 'A6', position: 13 },
            { leftMin: 400, leftMax: 450, top: 50, note: 'B6', position: 14 },
        ];

        function getRandomInt(min, max) {
            return Math.floor(Math.random() * (max - min + 1)) + min;
        }

        function getIntervalRange(difficultyLevel) {
            // Détermine l'intervalle en fonction de la difficulté
            switch (difficultyLevel) {
                case 1:
                    return 3; // Faible difficulté, petits intervalles
                case 2:
                    return 5; // Intervalle de 5 notes
                case 3:
                    return 7; // Intervalle plus large
                case 4:
                    return 9; // Intervalle encore plus large
                case 5:
                    return 12; // Très grande difficulté
                default:
                    return 5;
            }
        }

        async function playNotes(notes) {
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            
            for (const note of notes) {
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();

                oscillator.type = 'sine';
                oscillator.frequency.setValueAtTime(noteToFrequency(note), audioContext.currentTime);

                const now = audioContext.currentTime;
                gainNode.gain.setValueAtTime(0, now);
                gainNode.gain.linearRampToValueAtTime(0.8, now + 0.01);
                gainNode.gain.linearRampToValueAtTime(0.6, now + 0.1);
                gainNode.gain.setValueAtTime(0.6, now + 0.2);
                gainNode.gain.linearRampToValueAtTime(0, now + 0.5);

                oscillator.connect(gainNode).connect(audioContext.destination);
                oscillator.start(now);
                oscillator.stop(now + 0.5);

                await new Promise(resolve => setTimeout(resolve, noteInterval));
            }

            audioContext.close();
        }

        function noteToFrequency(note) {
            const noteFrequencies = {
                "C5": 523.25, "D5": 587.33, "E5": 659.25, "F5": 698.46, "G5": 783.99, "A5": 880.00, "B5": 987.77,
                "C6": 1046.50, "D6": 1174.66, "E6": 1318.51, "F6": 1396.91, "G6": 1567.98, "A6": 1760.00, "B6": 1975.53
            };
            return noteFrequencies[note] || 440;
        }

        async function updateNotes() {
            croppedImagesContainer.innerHTML = '';
            const selectedNotes = [];
            const range = getIntervalRange(difficulty);
            const randomStart = getRandomInt(0, notesPositions.length - range);
            const randomIndexes = [];

            // Sélection de notes aléatoires dans l'intervalle sans répétition et non ordonnée
            while (randomIndexes.length < 5) {
                let randomNoteIndex = getRandomInt(randomStart, randomStart + range - 1);
                if (!randomIndexes.includes(randomNoteIndex)) {
                    randomIndexes.push(randomNoteIndex);
                    const position = notesPositions[randomNoteIndex];
                    selectedNotes.push(position.note);

                    const div = document.createElement('div');
                    div.className = 'cropped-image';

                    const img = document.createElement('img');
                    img.src = 'images/notes.jpg';
                    img.style.left = `-${position.leftMin}px`;
                    img.style.top = `-${position.top}px`;

                    const noteLabel = document.createElement('div');
                    noteLabel.className = 'note-label';
                    noteLabel.textContent = position.note;

                    const debugInfo = document.createElement('div');
                    debugInfo.className = 'debug-info';
                    debugInfo.textContent = `Note: ${position.note}, Position: ${position.position}`;

                    div.appendChild(img);
                    div.appendChild(noteLabel);
                    div.appendChild(debugInfo);
                    croppedImagesContainer.appendChild(div);
                }
            }

            await new Promise(resolve => setTimeout(resolve, soundDelay));
            await playNotes(selectedNotes);
        }
    </script>
</body>
</html>
