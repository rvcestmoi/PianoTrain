<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rognage de Partition</title>
    <style>
        body {
            display: flex;
            flex-direction: column;
            align-items: center;
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
        }
        h1 {
            margin-top: 20px;
        }
        .controls {
            margin: 20px 0;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .control {
            margin: 10px;
        }
        .cropped-images {
            display: flex;
            flex-wrap: wrap;
            gap: 0px;
            margin-top: 0px;
        }
        .cropped-image {
            overflow: hidden;
            width: 50px;
            height: 191px;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            flex-direction: column;
        }
        .cropped-image img {
            position: absolute;
        }
        .note-label {
            font-size: 16px;
            font-weight: bold;
            color: #333;
            margin-top: 120px;
            position: relative;
        }
        .debug-info {
            font-size: 12px;
            color: #555;
            position: absolute;
            bottom: 5px;
            left: 5px;
            background: rgba(255, 255, 255, 0.8);
            padding: 2px;
        }
    </style>
</head>
<body>
    <h1>Rognage de Partition</h1>
    
    <div class="controls">
        <div class="control">
            <label for="noteIntervalSlider">Temps entre les sons (ms): <span id="noteIntervalValue"></span></label>
            <input type="range" id="noteIntervalSlider" min="100" max="1000" step="50">
        </div>
        <div class="control">
            <label for="imageChangeIntervalSlider">Temps entre les changements d'image (ms): <span id="imageChangeIntervalValue"></span></label>
            <input type="range" id="imageChangeIntervalSlider" min="1000" max="10000" step="500">
        </div>
        <div class="control">
            <label for="soundDelaySlider">Délai avant le son (ms): <span id="soundDelayValue"></span></label>
            <input type="range" id="soundDelaySlider" min="0" max="5000" step="100">
        </div>
        <div class="control">
            <label for="difficultySlider">Difficulté: <span id="difficultyValue"></span></label>
            <input type="range" id="difficultySlider" min="1" max="5" step="1">
        </div>
        <button id="startStopButton">Start</button>
    </div>
    
    <div class="cropped-images"></div>

    <script>
        let noteInterval = 600;
        let imageChangeInterval = 6000;
        let soundDelay = 3000;
        let difficulty = 3;
        let intervalId = null;
        let isPlaying = false;

        const croppedImagesContainer = document.querySelector('.cropped-images');
        const noteIntervalSlider = document.getElementById('noteIntervalSlider');
        const imageChangeIntervalSlider = document.getElementById('imageChangeIntervalSlider');
        const soundDelaySlider = document.getElementById('soundDelaySlider');
        const difficultySlider = document.getElementById('difficultySlider');
        const noteIntervalValue = document.getElementById('noteIntervalValue');
        const imageChangeIntervalValue = document.getElementById('imageChangeIntervalValue');
        const soundDelayValue = document.getElementById('soundDelayValue');
        const difficultyValue = document.getElementById('difficultyValue');
        const startStopButton = document.getElementById('startStopButton');

        // Initialize the sliders and labels with the variable values
        function initializeSliders() {
            noteIntervalSlider.value = noteInterval;
            imageChangeIntervalSlider.value = imageChangeInterval;
            soundDelaySlider.value = soundDelay;
            difficultySlider.value = difficulty;

            noteIntervalValue.textContent = noteInterval;
            imageChangeIntervalValue.textContent = imageChangeInterval;
            soundDelayValue.textContent = soundDelay;
            difficultyValue.textContent = difficulty;
        }

        noteIntervalSlider.addEventListener('input', () => {
            noteInterval = parseInt(noteIntervalSlider.value);
            noteIntervalValue.textContent = noteInterval;
        });

        imageChangeIntervalSlider.addEventListener('input', () => {
            imageChangeInterval = parseInt(imageChangeIntervalSlider.value);
            imageChangeIntervalValue.textContent = imageChangeInterval;
        });

        soundDelaySlider.addEventListener('input', () => {
            soundDelay = parseInt(soundDelaySlider.value);
            soundDelayValue.textContent = soundDelay;
        });

        difficultySlider.addEventListener('input', () => {
            difficulty = parseInt(difficultySlider.value);
            difficultyValue.textContent = difficulty;
        });

        startStopButton.addEventListener('click', () => {
            if (isPlaying) {
                clearInterval(intervalId);
                intervalId = null;
                startStopButton.textContent = 'Start';
                isPlaying = false;
            } else {
                updateNotes();
                intervalId = setInterval(updateNotes, imageChangeInterval);
                startStopButton.textContent = 'Stop';
                isPlaying = true;
            }
        });

        const notesPositions = [
            {"leftMin": 0, "leftMax": 43, "top": 0, "note": "A4"},
            {"leftMin": 43, "leftMax": 96, "top": 0, "note": "B4"},
            {"leftMin": 96, "leftMax": 149, "top": 0, "note": "C4"},
            {"leftMin": 149, "leftMax": 202, "top": 0, "note": "D4"},
            {"leftMin": 202, "leftMax": 255, "top": 0, "note": "E4"},
            {"leftMin": 255, "leftMax": 308, "top": 0, "note": "F5"},
            {"leftMin": 308, "leftMax": 361, "top": 0, "note": "G5"},
            {"leftMin": 361, "leftMax": 414, "top": 0, "note": "A5"},
            {"leftMin": 414, "leftMax": 467, "top": 0, "note": "B5"},
            {"leftMin": 467, "leftMax": 520, "top": 0, "note": "C5"},
            {"leftMin": 520, "leftMax": 573, "top": 0, "note": "D5"},
            {"leftMin": 573, "leftMax": 626, "top": 0, "note": "E5"},
            {"leftMin": 626, "leftMax": 679, "top": 0, "note": "F6"},
            {"leftMin": 679, "leftMax": 732, "top": 0, "note": "G6"},
            {"leftMin": 732, "leftMax": 785, "top": 0, "note": "A6"},
            {"leftMin": 785, "leftMax": 838, "top": 0, "note": "B6"},
            {"leftMin": 838, "leftMax": 869, "top": 0, "note": "C6"}
        ];

        initializeSliders();

        function getRandomInt(min, max) {
            return Math.floor(Math.random() * (max - min + 1)) + min;
        }

        function getIntervalRange(difficultyLevel) {
            switch (difficultyLevel) {
                case 1:
                    return 3; // Faible difficulté, petits intervalles
                case 2:
                    return 5; // Intervalle de 5 notes
                case 3:
                    return 7; // Intervalle plus large
                case 4:
                    return 9; // Intervalle encore plus large
                case 5:
                    return 12; // Très grande difficulté
                default:
                    return 5;
            }
        }

        async function playNotes(notes) {
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            for (const note of notes) {
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                oscillator.type = 'sine';
                oscillator.frequency.setValueAtTime(noteToFrequency(note), audioContext.currentTime);

                const now = audioContext.currentTime;
                gainNode.gain.setValueAtTime(0, now);
                gainNode.gain.linearRampToValueAtTime(0.8, now + 0.01);
                gainNode.gain.linearRampToValueAtTime(0.6, now + 0.1);
                gainNode.gain.setValueAtTime(0.6, now + 0.2);
                gainNode.gain.linearRampToValueAtTime(0, now + 0.5);

                oscillator.connect(gainNode).connect(audioContext.destination);
                oscillator.start(now);
                oscillator.stop(now + 0.5);

                await new Promise(resolve => setTimeout(resolve, noteInterval));
            }

            audioContext.close();
        }

        function noteToFrequency(note) {
            const noteFrequencies = {
    "A4": 440.00,
    "B4": 493.88,
    "C4": 261.63,
    "D4": 293.66,
    "E4": 329.63,
    "F5": 698.46,
    "G5": 783.99,
    "A5": 880.00,
    "B5": 987.77,
    "C5": 523.25,
    "D5": 587.33,
    "E5": 659.25,
    "F6": 1396.91,
    "G6": 1567.98,
    "A6": 1760.00,
    "B6": 1975.53,
    "C6": 1046.50
};
            return noteFrequencies[note] || 440;
        }

        async function updateNotes() {
            croppedImagesContainer.innerHTML = '';
            const selectedNotes = [];
            const range = getIntervalRange(difficulty);
            const startPosition = getRandomInt(0, notesPositions.length - range);
            const noteSet = notesPositions.slice(startPosition, startPosition + range);
            const shuffledNotes = noteSet.sort(() => 0.5 - Math.random()).slice(0, 5);

            shuffledNotes.forEach(position => {
                selectedNotes.push(position.note);

                const div = document.createElement('div');
                div.className = 'cropped-image';

                const img = document.createElement('img');
                img.src = 'images/notes.png';
                img.style.left = `-${position.leftMin}px`;
                img.style.top = `-${position.top}px`;

                div.appendChild(img);

                croppedImagesContainer.appendChild(div);
            });

            await new Promise(resolve => setTimeout(resolve, soundDelay));
            await playNotes(selectedNotes);
        }
    </script>
</body>
</html>
